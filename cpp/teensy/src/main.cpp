/*
IMPORTANT INFORMATION!

Some libraries are not imported properly when downloading from GitHub
This is because they are to big and so they get auto deleted
For now the libraries that need to be manually installed are
- CMSIS
To import libraries properly do this:
Copy file from ".\vortex-acoustics\Resource\CMSIS" to ".\vortex-acoustics\cpp\teensy\.pio\libdeps\teensy41\CMSIS"

Code written by: Vortex NTNU
*/



#include "DSP.h"
#include "arm_const_structs.h"
#include "arm_math.h"
#include <Arduino.h>

/*
These are just to measure the time it takes to run the entire code.
The new calculations show 732 us (micro seconds) for the whole algorithm
*/
unsigned long timeDiff;
unsigned long startTime;
unsigned long endTime;

// A manual valiable to filter out small peaks that dont manage to get over the threshold
const q15_t peakThreshold = 200;

int16_t samplesRaw[SAMPLE_LENGTH] = {
-4538, -3903, -2956, -4086, -9103, -12047, -13055, -12626, -13841, -12067, -7969, -4561, -2092, -650, 73, 1379, 1427, 3125, 4971, 5439, 11880, 15154, 13317, 15047, 12227, 8030, 4048, 2626, 29, -1850, 1059, 1287, -487, 3952, 1251, -276, 131, -699, -175, 1926, 5182, 7130, 7880, 10204, 9338, 8154, 4545, 1575, -895, -3018, -4491, -3488, -3088, -4998, -5893, -3804, -9424, -9571, -9855, -9367, -4552, -986, 1489, 4374, 5340, 7638, 5136, 2865, 3302, 250, -757, -55, -1316, 59, -1669, -5015, -7508, -10772, -12937, -14644, -13348, -11181, -8927, -5526, -2060, -5323, -3630, -3242, -5254, -6426, -4509, -3697, -3320, -1093, -3437, -5349, -10015, -10245, -13752, -15201, -18640, -14442, -12423, -10933, -7091, -5501, -4792, -6353, -4853, -955, -1897, 3830, 7963, 8819, 11540, 11276, 10395, 8291, 5943, 2394, 2781, 813, 3530, 4379, 5632, 4649, 6955, 5178, 4388, 2198, 6001, 8308, 9290, 14726, 14985, 17793, 16630, 15185, 10995, 9972, 7507, 5796, 3695, 4320, 4699, 3144, 1635, -536, -2313, -6366, -6584, -4636, -1098, 2393, 6164, 6879, 7458, 6645, 4564, 7492, 4952, 6247, 6541, 6972, 5163, 5122, 5656, 1537, -3561, -5030, -9107, -9699, -7699, -5061, -1565, 1325, 3738, 4612, 3633, 2115, 1771, 2386, 1684, 4849, 5886, 4273, 8294, 3504, 297, -4785, -10657, -11699, -12665, -13312, -11726, -9250, -7239, -8338, -6149, -8839, -6918, -6091, -5891, -1802, 883, 6489, 6636, 7254, 5652, 2569, -940, -1455, -3447, -1542, -1726, 916, 3664, 3671, 895, 3926, 1665, 1635, 3291, 8244, 12620, 14644, 17293, 19699, 19813, 18880, 16606, 14812, 13146, 12273, 11956, 12781, 12860, 11536, 7109, 6446, 853, -1537, -1866, 595, 2828, 4292, 8548, 10036, 12922, 10310, 9866, 7904, 8360, 6822, 8191, 10191, 9049, 8193, 7505, 3842, 410, -5004, -5198, -6362, -4900, -2708, -607, 1300, 2900, 4718, 3306, 2031, 3292, 5677, 7808, 8391, 9484, 8790, 10607, 8358, 2680, -644, -4544, -7257, -7817, -7158, -6527, -7218, -7218, -7792, -7302, -8043, -6999, -6208, -6998, -2940, 874, 2493, 5125, 3070, 1010, 323, -3073, -7050, -8775, -8152, -5889, -7760, -8456, -6330, -5785, -5698, -11175, -7415, -5401, -3831, 4302, 6069, 8867, 11162, 12763, 11933, 10353, 11817, 8735, 8695, 9168, 12842, 13027, 10324, 8577, 5432, 3326, 1445, 1556, -825, 3579, 7257, 8556, 12244, 11426, 9845, 8330, 10355, 11800, 9799, 10792, 11312, 11548, 11776, 6473, 2281, -734, -3892, -5150, -6152, -6112, -6119, -2578, -1449, -791, -22, 703, -999, -1602, 727, 4015, 5554, 6804, 10159, 8075, 7672, 5849, -1193, -3918, -4473, -5427, -3711, -6696, -5504, -5902, -7941, -5448, -9644, -10070, -7632, -8029, -3004, 613, 3737, 1699, 1499, 806, -2460, -5430, -8871, -10207, -9888, -9187, -11096, -12506, -12893, -13283, -16827, -18586, -19119, -15431, -12945, -8121, -6250, -2505, -246, -1013, 1144, -755, -1813, 562, 513, 2122, 2327, 3730, 1407, -533, -1444, -4558, -6001, -5343, -4118, -3372, 2821, 4554, 6661, 7509, 7654, 7262, 7590, 9085, 8888, 11997, 12586, 12820, 11991, 9319, 4963, 1354, -1700, -4092, -6457, -4677, -3831, -4139, -1869, -2779, -2303, -3807, -3570, -2942, 385, 1402, 3329, 6000, 6047, 6303, 3516, 744, -1349, -4257, -7123, -8297, -6150, -6816, -6680, -7716, -7719, -10364, -11607, -9448, -9708, -7516, -4998, -1594, 3624, 6300, 1940, 732, -1472, -3095, -4568, -6117, -7348, -7844, -7455, -8646, -11140, -13888, -17307, -19859, -20802, -16426, -14841, -13658, -10269, -8649, -7273, -4242, -7503, -7512, -8256, -6140, -6705, -4649, -3085, -1938, -4739, -7268, -11400, -13377, -15211, -13909, -12520, -6429, -6013, -2389, 1696, 1240, 1828, 3507, 2870, 5196, 7657, 10358, 12546, 14058, 12063, 11545, 9329, 2616, 453, 697, -2632, 914, 2564, 1395, 2627, 1349, 1109, -2275, 746, 1243, -3, 5762, 6366, 10226, 11732, 10495, 8111, 5004, 1598, -2166, -3417, -3955, -2540, -2894, -4968, -6803, -6979, -9510, -11530, -9014, -10078, -6071, -798, 504, 3609, 5314, 6611, 4072, 4433, -457, -253, -355, 2236, -2429, -1649, -3410, -4710, -8665, -11689, -13534, -16426, -14316, -12109, -8403, -4632, -4107, -2676, -4262, -2810, -4013, -5335, -5144, -1860, -1841, -633, -2108, -4541, -9655, -10168, -14223, -16938, -16008, -15026, -11744, -9891, -8919, -7336, -6134, -5047, -4371, -2740, 1889, 2590, 4825, 9464, 11403, 11408, 9457, 7566, 5317, 3599, 2496, 538, 1174, 2336, 4830, 5215, 4371, 2798, 2565, 4883, 3419, 7575, 11445, 14901, 17218, 15500, 18520, 17336, 10322, 10055, 6636, 4567, 5061, 4127, 3943, 2345, 1020, -2431, -3885, -5630, -7327, -4947, -3875, 359, 4322, 7143, 8641, 8537, 7428, 7293, 6461, 3692, 5717, 5295, 7051, 4817, 3919, 1682, -2274, -5654, -7653, -7400, -8912, -5202, 1, 2181, 3114, 3361, 1501, 1091, 1591, 608, 2756, 2899, 5517, 7257, 5124, 3174, 393, -5591, -8781, -11235, -13079, -13142, -10766, -8823, -8958, -8260, -7146, -6398, -8495, -7384, -3630, -1857, 2161, 3211, 8061, 6077, 6086, 2637, -73, -3157, -2649, -3787, -1908, 1812, 2585, 2402, 952, 3356, 1382, -585, 2240, 7138, 11636, 16048, 17682, 20690, 20769, 18011, 16235, 16009, 12106, 12051, 10641, 12040, 12935, 11931, 8682, 6371, 2360, 890, -2324, -293, 3130, 5048, 7252, 11436, 11051, 11092, 9394, 7482, 8045, 9247, 7319, 8267, 9297, 9138, 5841, 4021, 1075, -2727, -4125, -6480, -6089, -2267, -989, 1892, 2998, 2779, 5380, 4394, 3673, 2901, 6486, 8557, 10728, 12210, 7892, 7922, 2688, 494, -3530, -6949, -6265, -8470, -6643, -5826, -6358, -5740, -6383, -8266, -7403, -7344, -7283, -3569, 422, 1728, 4772, 2692, 2307, -971, -5323, -5085, -8952, -8578, -5589, -6794, -5655, -6494, -8285, -7105, -9489, -9791, -5061, -3315, 2273, 4538, 9689, 11524, 12914, 13477, 12807, 11211, 9621, 10069, 10980, 12792, 14122, 11186, 9667, 5056, 2723, -589, -179, 389, 2044, 7157, 8443, 11288, 12271, 11104, 12576, 11422, 9084, 9933, 9935, 11478, 9260, 9329, 7672, 3991, 1099, -4357, -8372, -7103, -8641, -6761, -2383, -67, 1661, -978, -1660, -771, 76, 775, 2381, 5653, 6431, 6945, 7263, 6882, 2607, 735, -4326, -5571, -5888, -4956, -3065, -3938, -6104, -5406, -7567, -10159, -9069, -8817, -7074, -4432, -2540, 566, 4418, 2305, 56, -1556, -5374, -8163, -9569, -10816, -10694, -10966, -11573, -13151, -13862, -16877, -18463, -16829, -18726, -13436, -10017, -6037, -1637, -1113, 971, 1853, -184, -301, -1242, 85, 1492, 4850, 3104, 4062, -1384, -580, -4645, -9041, -6202, -4832, -2556, 322, 3568, 6754, 9362, 10131, 7912, 7255, 6673, 10146, 11901, 12472, 15142, 13052, 11088, 7580, 3736, -3026, -5569, -5656, -4778, -5746, -4231, -3589, -1791, -2597, -2798, -2904, -2751, -1892, 648, 4259, 5843, 7226, 7315, 5364, -105, -2938, -6307, -6822, -5317, -7191, -5572, -6898, -6615, -7659, -7835, -9891, -9755, -9729, -5865, -4188, -305, 2628, 3971, 2829, 3556, -2500, -4011, -2763, -7928, -4948, -8678, -5805, -8448, -12425, -13045, -16513, -18379, -18437, -18243, -16686, -13273, -9375, -6666, -5943, -10034, -7100, -8026, -9022, -7999, -8694, -4983, -1931, -3371, -7400
};

void setup() {
    Serial.begin(9600);
    delay(3000);
    Serial.println("Test");

    // Start timer to see time it takes for everything to run
    startTime = micros();


    // Digital Signal Processing (START) ==========
    q15_t* samplesFiltered = filter_butterwort_9th_order_50kHz(samplesRaw);  

    q15_t* FFTResultsRaw = FFT_raw(samplesFiltered);
    q15_t* FFTResults = FFT_mag(FFTResultsRaw);

    q31_t** peaks = peak_detection(FFTResultsRaw, FFTResults, peakThreshold);
    
    /*
    Since we are storing the length of the array in the first index, we do
    not start from 0 in the array when printing out. Find out how to get
    length of a 2D array of a q31_t datatype. For now we return the length of
    the array in the first index of 2D array, This must be solved, this is
    not a good solution.
    */
    int lengthOfPeakArray = peaks[0][0];

    // TIPS: For getting phase of the peak FFTs from q31 format that we dont understand to radians in floats, use this:
    // phaseQ31_to_radianFloat32(peaks[x][2]);
    // Digital Signal Processing (STOP) ==========


    // End timer for testing speed of algorithm
    endTime = micros();

    // Print out how long it takes to run the whole algorithm
    timeDiff = endTime - startTime;
    Serial.print("StartTime: ");
    Serial.println(startTime);
    Serial.print("EndTime: ");
    Serial.println(endTime);
    Serial.print("Time: ");
    Serial.println(timeDiff); 

    // Print Filtered signal response
    Serial.println("");
    Serial.println("=====================================================================================");
    Serial.println("Filtered samples");
    for (int i = 0; i < SAMPLE_LENGTH; i++) {
        Serial.print(samplesFiltered[i]);
        Serial.print(", ");
    }

    // Print FFT
    Serial.println("");
    Serial.println("=====================================================================================");
    Serial.println("FFT");
    for (int i = 0; i < SAMPLE_LENGTH; i++) {
        Serial.print(FFTResults[i]);
        Serial.print(", ");
    }

    // Print peaks of FFT
    Serial.println("");
    Serial.println("=====================================================================================");
    Serial.println("Peaks");
    Serial.println(lengthOfPeakArray);
    Serial.println("[Amplitude, Frequency, Phase in radians]");
    for (int i = 1; i < lengthOfPeakArray; i++) {
        Serial.print("[");
        Serial.print(peaks[i][0]);
        Serial.print(", ");
        Serial.print(peaks[i][1]);
        Serial.print(", ");

        // Calculate phase in comprehensible manner
        // peaks[i][2] is q31_t type but in the taylor expansion it is actually q15_t, the rest of the 16 MSB are just 0,
        // The reason it is q31_t is just because we send it with all the frequencies, witch are really big and require q31_t to be stored properly
        float32_t phase_in_radians = phaseQ31_to_radianFloat32(peaks[i][2]);

        Serial.print(phase_in_radians);

        Serial.println("],");
    }
}

void loop() {
  //Serial.println("Test");
}
